{% extends 'base.html.twig' %}

{% block title %}Catalogue - Médiathèque{% endblock %}

{% block body %}
<section class="services-section">
    <div class="container">
        <!-- Header -->
        <div class="section-header">
            <h1>Catalogue</h1>
            <p>Explorez notre collection de documents.</p>
        </div>

        <!-- Toolbar -->
        <div class="service-card" style="margin-bottom: 3rem;">
            <form action="{{ path('document_index') }}" method="get" class="btn-group" style="align-items: center;">
                <div style="flex: 2; min-width: 250px;">
                    <input type="text" name="q" value="{{ app.request.query.get('q') }}" class="form-input" placeholder="Rechercher par titre, auteur..." style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white;">
                </div>
                
                <div style="flex: 1; min-width: 150px;">
                    <select name="type" class="form-select" onchange="this.form.submit()" style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: #1e293b; color: white;">
                        <option value="">Tous les types</option>
                        <option value="Livre" {{ app.request.query.get('type') == 'Livre' ? 'selected' : '' }}>Livres</option>
                        <option value="CD" {{ app.request.query.get('type') == 'CD' ? 'selected' : '' }}>CDs</option>
                        <option value="DVD" {{ app.request.query.get('type') == 'DVD' ? 'selected' : '' }}>DVDs</option>
                        <option value="Magazine" {{ app.request.query.get('type') == 'Magazine' ? 'selected' : '' }}>Magazines</option>
                        <option value="BD" {{ app.request.query.get('type') == 'BD' ? 'selected' : '' }}>BDs</option>
                    </select>
                </div>

                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="disponible" id="dispo" value="1" {{ app.request.query.get('disponible') ? 'checked' : '' }} onchange="this.form.submit()">
                    <label for="dispo" style="cursor: pointer; color: var(--text-muted);">Disponibles</label>
                </div>

                <button type="submit" class="btn-modern btn-primary">
                    <i class="fas fa-search"></i> Filtrer
                </button>
            </form>
        </div>

        <!-- Grid -->
        {% if documents is empty %}
            <div class="service-card" style="text-align: center;">
                <i class="fas fa-search" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                <h3>Aucun document trouvé</h3>
                <p>Essayez de modifier vos filtres.</p>
                <a href="{{ path('document_index') }}" class="btn-modern btn-secondary">Voir tout le catalogue</a>
            </div>
        {% else %}
            <div class="services-grid">
                {% for document in documents %}
                    <div class="service-card" onclick="window.location='{{ path('document_show', {'id': document.id}) }}'" style="cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <span style="background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem;">{{ document.type }}</span>
                            <span style="{{ document.disponible ? 'color: #10b981;' : 'color: #ef4444;' }} font-weight: 600; font-size: 0.9rem;">
                                {{ document.disponible ? 'Disponible' : 'Emprunté' }}
                            </span>
                        </div>

                        {% if is_granted('ROLE_ADHERENT') and document.disponible %}
                            <div class="mb-2">
                                {% if has_retards %}
                                    <button class="btn btn-sm btn-secondary w-100" disabled title="Vous avez des retards en cours">
                                        <i class="fas fa-ban"></i> Bloqué
                                    </button>
                                {% elseif document.id in pending_doc_ids %}
                                    <button class="btn btn-sm btn-warning w-100" disabled>
                                        <i class="fas fa-clock"></i> En attente
                                    </button>
                                {% else %}
                                    <a href="{{ path('app_adherent_demande_emprunt', {id: document.id}) }}" class="btn btn-sm btn-primary w-100" onclick="event.stopPropagation();">
                                        <i class="fas fa-hand-paper"></i> Emprunter
                                    </a>
                                {% endif %}
                            </div>
                        {% endif %}

                        <h3>{{ document.titre }}</h3>
                        <p style="color: var(--accent-cyan); font-weight: 500; margin-bottom: 1rem;">{{ document.auteur }}</p>

                        {% if document.resume %}
                            <p style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                {{ document.resume }}
                            </p>
                        {% endif %}
                        
                        <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end;">
                            <span class="service-link">
                                Voir détails <i class="fas fa-arrow-right"></i>
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}
